<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate" />
  <meta http-equiv="Pragma" content="no-cache" />
  <meta http-equiv="Expires" content="0" />
  <title>Per Autisti • Riepilogo Fermate / Zusammenfassung der Haltestellen</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&display=swap" rel="stylesheet">
  <style>
    :root{--bg1:#e6f1ff;--bg2:#e9f8f2;--card:#fff;--ink:#0f172a;--sub:#475569;--ok:#16a34a;--chip:#eaf7ef;--line:#e6eaf0;--radius:18px;--shadow:0 8px 24px rgba(0,0,0,.08)}
    html,body{margin:0;font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;background:linear-gradient(135deg,var(--bg1),var(--bg2)) fixed;color:var(--ink)}
    .wrap{max-width:1100px;margin:32px auto;padding:0 16px}
    .head{display:flex;align-items:center;gap:16px;justify-content:space-between;margin-bottom:20px}
    .title{font-size:28px;font-weight:800;letter-spacing:.2px}
    .muted{color:var(--sub);font-size:14px}
    .pill{padding:6px 10px;border-radius:999px;background:var(--chip);color:var(--ok);font-weight:600;font-size:12px}
    .grid{display:grid;grid-template-columns:1fr 1fr;gap:18px}
    @media (max-width:900px){.grid{grid-template-columns:1fr}}
    .card{background:var(--card);border-radius:var(--radius);box-shadow:var(--shadow);padding:16px 16px 10px}
    .card h2{margin:0 0 6px 0;font-size:18px}
    .sub{margin:0;color:var(--sub);font-size:13px}
    .slot{background:#f7fafc;border:1px solid var(--line);border-radius:14px;padding:10px 12px;margin-top:12px}
    .slot h3{margin:0 0 6px 0;font-size:15px}
    .badge{display:inline-block;margin-left:8px;padding:2px 8px;border-radius:999px;background:#eef2ff;color:#4338ca;font-weight:700;font-size:12px}
    .table{width:100%;border-collapse:separate;border-spacing:0 8px;margin-top:4px}
    .th{font-size:12px;color:var(--sub);text-transform:uppercase;letter-spacing:.4px}
    .rowline{background:#fff;border:1px solid var(--line);box-shadow:0 2px 8px rgba(0,0,0,.04)}
    .cell{padding:10px 12px}
    .cell:first-child{border-top-left-radius:10px;border-bottom-left-radius:10px}
    .cell:last-child{border-top-right-radius:10px;border-bottom-right-radius:10px;text-align:right;font-weight:800}
    .empty{padding:14px;border:1px dashed var(--line);border-radius:12px;background:#fafafa;color:var(--sub);text-align:center;margin-top:12px}
    .btn{border:1px solid var(--line);background:#fff;border-radius:12px;padding:8px 10px;font-weight:600;cursor:pointer}
    .err{font-size:12px;color:#b91c1c;margin-top:6px;white-space:pre-wrap}
  </style>
</head>
<body>
  <div class="wrap">
    <div class="head">
      <div>
        <div class="title">Per Autisti • Riepilogo Fermate / Zusammenfassung der Haltestellen</div>
        <div class="muted" id="subtitle">Dati in tempo quasi reale dal Google Sheet. Aggiornamento automatico ogni 60 secondi.</div>
      </div>
      <div>
        <button class="btn" id="refreshBtn" title="Aggiorna / Aktualisieren">⟳ Aggiorna</button>
        <span class="pill" id="stamp">—</span>
      </div>
    </div>

    <div class="grid">
      <div class="card">
        <h2>Andata / Hinfahrt</h2>
        <p class="sub">Orario + Fermata scelta per l’andata / Uhrzeit + gewählter Ausstiegspunkt.</p>
        <div id="andata"></div>
      </div>
      <div class="card">
        <h2>Ritorno / Rückfahrt</h2>
        <p class="sub">Orario + Punto di partenza scelto / Uhrzeit + gewählter Startpunkt.</p>
        <div id="ritorno"></div>
      </div>
    </div>

    <div class="muted" style="margin-top:16px" id="footerNote">Pronto.</div>
  </div>

<script>
/* ====== CONFIG ====== */
const SHEET_ID = "1swHUZ3IyV9dw1Y9EqzuChMGOP7lOwOrIIPX190wOnAc";
const CANDIDATE_SHEETS = [
  "Heute / Oggi","Morgen / Domani","Riepilogo Fermate Autisti","Skibus Prenotazioni","Andata","Ritorno"
];
const REFRESH_MS = 60000;

/* ====== DOM ====== */
const stampEl = document.getElementById("stamp");
const footerEl = document.getElementById("footerNote");
const andataEl = document.getElementById("andata");
const ritornoEl = document.getElementById("ritorno");
document.getElementById("refreshBtn").addEventListener("click", loadAll);

/* ====== UTILS ====== */
const norm = v => (v==null?"":String(v)).trim();
const low  = s => norm(s).toLowerCase();
const isTime = s => /^\d{1,2}:\d{2}$/.test(s||"");
const sum   = arr => arr.reduce((a,b)=>a+(Number(String(b).replace(",", "."))||0),0);
function setStamp(){ stampEl.textContent = "Aggiornato • Aktualisiert: " + new Date().toLocaleString(undefined,{hour12:false}); }
function url(sheet){ return `https://docs.google.com/spreadsheets/d/${SHEET_ID}/gviz/tq?tqx=out:json&sheet=${encodeURIComponent(sheet)}&t=${Date.now()}`; }

/* parole chiave per trovare le intestazioni, multilingua e flessibili */
const KW = {
  time: ["uhrzeit","orario"],
  stopOut: ["ausstieg","ausstiegspunkt","fermata"],
  stopBack:["startpunkt","punto di partenza"],
  peopleGeneric: ["personen","persone","anzahl","totale","gesamt"],
  outHints: ["hinfahrt","andata","hin","ausstieg"],
  backHints:["rückfahrt","ritorno","zurück","zurueck","startpunkt"]
};
/* colonne “numeriche” alternative per calcolare le persone */
const KW_NUM = {
  out:  ["posti andata","plätze hinfahrt","plaetze hinfahrt","hin","andata"],
  back: ["posti ritorno","plätze rückfahrt","plaetze rueckfahrt","rück","ritorno"]
};
const KW_EXTRA_NUM = ["adulti","kinder","bambini","erwachsene","gesamt","totale","total","persons","people","anzahl","count"];

/* ====== CORE ====== */
async function fetchRows(sheetName){
  const res = await fetch(url(sheetName), {cache:"no-store"});
  if(!res.ok) throw new Error(`HTTP ${res.status}`);
  const txt = await res.text();
  const json = JSON.parse(txt.substring(txt.indexOf("{"), txt.lastIndexOf("}")+1));
  const t = json.table;
  if(!t || !t.rows) throw new Error("Formato GViz inatteso");
  const rows = t.rows.map(r => (r.c||[]).map(c => norm(c && (c.f ?? c.v))));
  const labels = (t.cols||[]).map(c => norm(c && c.label));
  return {rows, labels};
}

function findHeaderRow(rows, keywords, maxScan=30){
  const lim = Math.min(rows.length, maxScan);
  for(let r=0; r<lim; r++){
    const line = rows[r].map(x => low(x));
    const hits = line.filter(cell => keywords.some(k => cell.includes(k))).length;
    if(hits >= 2) return r;
  }
  return -1;
}

function findIndex(headers, keys){
  const H = headers.map(h => low(h));
  return H.findIndex(h => keys.some(k => h.includes(k)));
}

function numericColsForMode(headers, mode){
  const H = headers.map(h => low(h));
  const primKeys = (mode==="out"?KW_NUM.out:KW_NUM.back).map(k=>low(k));
  const extraKeys= KW_EXTRA_NUM.map(k=>low(k));

  const primary = [];
  H.forEach((h,i)=>{ if(primKeys.some(k=>h.includes(k))) primary.push(i); });

  const extra = [];
  H.forEach((h,i)=>{ if(extraKeys.some(k=>h.includes(k))) extra.push(i); });

  return {primary, extra};
}

function getPeopleFromRow(row, primaryIdxs, extraIdxs){
  const p1 = sum(primaryIdxs.map(i => row[i]));
  if(p1>0) return p1;
  const p2 = sum(extraIdxs.map(i => row[i]));
  return p2;
}

function extractSection(rows, headerRow, mode){ // mode: "out"|"back"
  if(headerRow<0) return {items:[], error:"Header non trovato."};
  const header = rows[headerRow];

  const timeIdx = findIndex(header, KW.time);
  const stopIdx = findIndex(header, mode==="out"?KW.stopOut:KW.stopBack);

  const {primary, extra} = numericColsForMode(header, mode);
  let peopleIdx = findIndex(header, KW.peopleGeneric);

  if(timeIdx<0 || stopIdx<0){
    return {items:[], error:`Manca colonna tempo/fermata (${mode}).`};
  }

  const items = [];
  for(let r=headerRow+1; r<rows.length; r++){
    const row = rows[r];
    const allEmpty = row.every(x => !norm(x));
    const looksLikeHeader = row.some(x=>{
      const s = low(x);
      return ["uhrzeit","orario","personen","persone","ausstieg","startpunkt","fermata","punto di partenza","hinfahrt","rückfahrt","andata","ritorno"].some(k=>s.includes(k));
    });
    if(allEmpty || looksLikeHeader) break;

    const time = norm(row[timeIdx]);
    const stop = norm(row[stopIdx]);

    let people = 0;
    if(peopleIdx>=0) people = Number(String(row[peopleIdx]).replace(",", ".")) || 0;
    if(people<=0){
      people = getPeopleFromRow(row, primary, extra);
    }

    if(!isTime(time) || !stop || people<=0) continue;
    items.push({time, stop, people});
  }
  return {items};
}

function groupByTime(items){
  const map = new Map();
  for(const it of items){
    const key = it.time + "|" + it.stop;
    map.set(key, (map.get(key)||0) + it.people);
  }
  const byTime = {};
  for(const [key,val] of map){
    const [t,s] = key.split("|");
    (byTime[t] ||= []).push({stop:s, people:val});
  }
  const times = Object.keys(byTime).sort((a,b)=>{
    const [ah,am]=a.split(":").map(Number);
    const [bh,bm]=b.split(":").map(Number);
    return (ah*60+am)-(bh*60+bm);
  });
  return {times, byTime};
}

function render(container, groups, emptyMsg){
  container.innerHTML = "";
  if(emptyMsg){
    container.innerHTML = `<div class="empty">${emptyMsg}</div>`;
    return;
  }
  if(groups.times.length===0){
    container.innerHTML = `<div class="empty">Nessuna prenotazione al momento / Keine Buchungen.</div>`;
    return;
  }
  for(const t of groups.times){
    const rows = groups.byTime[t].sort((a,b)=> a.stop.localeCompare(b.stop, undefined, {sensitivity:"base"}));
    const tot = rows.reduce((s,x)=>s+x.people,0);
    const wrap = document.createElement("div");
    wrap.className = "slot";
    wrap.innerHTML = `
      <h3>${t} <span class="badge">${tot} Personen / Persone</span></h3>
      <table class="table">
        <thead><tr class="th">
          <th class="cell" style="text-align:left">Haltestelle / Fermata</th>
          <th class="cell">Personen / Persone</th>
        </tr></thead>
        <tbody></tbody>
      </table>`;
    const tbody = wrap.querySelector("tbody");
    for(const r of rows){
      const tr = document.createElement("tr");
      tr.className = "rowline";
      tr.innerHTML = `<td class="cell">${r.stop}</td><td class="cell">${r.people}</td>`;
      tbody.appendChild(tr);
    }
    container.appendChild(wrap);
  }
}

async function loadAll(){
  footerEl.textContent = "Aggiornamento in corso… / Wird aktualisiert…";

  for(const sheetName of CANDIDATE_SHEETS){
    try{
      const {rows} = await fetchRows(sheetName);

      // Andata: header che contenga tempo + ausstieg/fermata
      const outHdr = findHeaderR
