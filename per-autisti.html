<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate" />
  <meta http-equiv="Pragma" content="no-cache" />
  <meta http-equiv="Expires" content="0" />
  <title>Riepilogo Fermate Autisti • Skibus</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
  <style>
    :root{
      --bg1:#e6f5ff; --bg2:#e9f8f2; --card:#ffffff; --ink:#0f172a; --sub:#475569; --ok:#16a34a; --chip:#eaf7ef; --line:#e6eaf0;
      --radius:18px; --shadow: 0 8px 24px rgba(0,0,0,.08);
    }
    html,body{margin:0;font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;background:linear-gradient(135deg,var(--bg1),var(--bg2)) fixed;color:var(--ink)}
    .wrap{max-width:1100px;margin:32px auto;padding:0 16px}
    .head{display:flex;align-items:center;gap:16px;justify-content:space-between;margin-bottom:20px}
    .title{font-size:28px;font-weight:800;letter-spacing:.2px}
    .muted{color:var(--sub);font-size:14px}
    .pill{padding:6px 10px;border-radius:999px;background:var(--chip);color:var(--ok);font-weight:600;font-size:12px}
    .grid{display:grid;grid-template-columns:1fr 1fr;gap:18px}
    @media (max-width:900px){.grid{grid-template-columns:1fr}}
    .card{background:var(--card);border-radius:var(--radius);box-shadow:var(--shadow);padding:16px 16px 10px}
    .card h2{margin:0 0 6px 0;font-size:18px}
    .sub{margin:0;color:var(--sub);font-size:13px}
    .row{display:flex;gap:12px;margin-top:12px}
    .col{flex:1}
    .slot{background:#f7fafc;border:1px solid var(--line);border-radius:14px;padding:10px 12px;margin-bottom:10px}
    .slot h3{margin:0 0 4px 0;font-size:15px}
    .slot .k{font-size:12px;color:var(--sub)}
    .slot .v{font-weight:700}
    .badge{display:inline-block;margin-left:8px;padding:2px 8px;border-radius:999px;background:#eef2ff;color:#4338ca;font-weight:700;font-size:12px}
    .footer{margin-top:16px;font-size:12px;color:var(--sub)}
    .lang{display:flex;gap:8px;align-items:center}
    .btn{border:1px solid var(--line);background:#fff;border-radius:12px;padding:8px 10px;font-weight:600;cursor:pointer}
    .table{width:100%;border-collapse:separate;border-spacing:0 8px;margin-top:8px}
    .th{font-size:12px;color:var(--sub);text-transform:uppercase;letter-spacing:.4px}
    .rowline{background:#fff;border:1px solid var(--line);box-shadow:0 2px 8px rgba(0,0,0,.04)}
    .cell{padding:10px 12px}
    .cell:first-child{border-top-left-radius:10px;border-bottom-left-radius:10px}
    .cell:last-child{border-top-right-radius:10px;border-bottom-right-radius:10px;text-align:right;font-weight:800}
    .empty{padding:14px;border:1px dashed var(--line);border-radius:12px;background:#fafafa;color:var(--sub);text-align:center}
  </style>
</head>
<body>
  <div class="wrap">
    <div class="head">
      <div>
        <div class="title">Per Autisti • Riepilogo Fermate / Zusammenfassung der Haltestellen</div>
        <div class="muted" id="subtitle">Dati in tempo quasi reale dal Google Sheet. Aggiornamento automatico ogni 60 secondi.</div>
      </div>
      <div class="lang">
        <button class="btn" id="refreshBtn" title="Aggiorna / Aktualisieren">⟳ Aggiorna</button>
        <span class="pill" id="stamp">—</span>
      </div>
    </div>

    <div class="grid">
      <div class="card">
        <h2>Andata / Hinfahrt</h2>
        <p class="sub">Raggruppato per Orario e Fermata scelta per l’andata / Uhrzeit und gewählter Ausstiegspunkt.</p>
        <div id="andata"></div>
      </div>
      <div class="card">
        <h2>Ritorno / Rückfahrt</h2>
        <p class="sub">Raggruppato per Orario e Punto di partenza scelto / Uhrzeit und gewählter Startpunkt.</p>
        <div id="ritorno"></div>
      </div>
    </div>

    <div class="footer" id="footerNote">Pronto.</div>
  </div>

<script>
/* ===================== CONFIG ===================== */
const SHEET_ID = "1swHUZ3IyV9dw1Y9EqzuChMGOP7lOwOrIIPX190wOnAc";
// Proveremo questi fogli in ordine finché uno risponde:
const CANDIDATE_SHEETS = [
  "Heute / Oggi", "Morgen / Domani", "Skibus Prenotazioni",
  "Riepilogo Fermate Autisti", "Andata", "Ritorno"
];
// Mappa intestazioni bilingue
const H = {
  time: [
    "Ora", "Uhrzeit", "Orario / Uhrzeit", "Uhrzeit / Orario"
  ],
  people: [
    "Persone", "Personen", "Persone / Personen"
  ],
  stopOut: [
    "Fermata scelta per l’andata", "Fermata scelta per l'andata",
    "Gewählter Ausstiegspunkt", "Fermata scelta per l’andata / Gewählter Ausstiegspunkt",
    "Gewaehlter Ausstiegspunkt" // fallback
  ],
  stopBack: [
    "Punto di partenza scelto", "Gewählter Startpunkt",
    "Punto di partenza scelto / Gewählter Startpunkt",
    "Gewaehlter Startpunkt" // fallback
  ]
};
// refresh ogni 60 s
const REFRESH_MS = 60000;

/* ===================== CORE ===================== */
const stampEl = document.getElementById("stamp");
const footerEl = document.getElementById("footerNote");
const andataEl = document.getElementById("andata");
const ritornoEl = document.getElementById("ritorno");
document.getElementById("refreshBtn").addEventListener("click", loadAll);

function nowStamp(){
  const d = new Date();
  return d.toLocaleString(undefined,{hour12:false});
}
function setStamp() { stampEl.textContent = "Aggiornato • Aktualisiert: " + nowStamp(); }

function gvizUrl(sheetName){
  const t = Date.now(); // anti-cache
  return `https://docs.google.com/spreadsheets/d/${SHEET_ID}/gviz/tq?tqx=out:json&sheet=${encodeURIComponent(sheetName)}&t=${t}`;
}

async function tryFetch(sheetName){
  const url = gvizUrl(sheetName);
  const res = await fetch(url, { cache: "no-store" });
  if(!res.ok) throw new Error(`HTTP ${res.status}`);
  const txt = await res.text();
  // risposta GViz: "google.visualization.Query.setResponse(...);"
  const json = JSON.parse(txt.substring(txt.indexOf("{"), txt.lastIndexOf("}")+1));
  if(!json.table || !json.table.rows) throw new Error("Formato GViz inatteso");
  return json.table;
}

function pickColIndex(headers, candidates){
  for(let i=0;i<headers.length;i++){
    const h = String(headers[i]||"").trim();
    for(const c of candidates){
      if(h.toLowerCase() === String(c).toLowerCase()) return i;
    }
  }
  // match parziale
  for(let i=0;i<headers.length;i++){
    const h = String(headers[i]||"").toLowerCase();
    for(const c of candidates){
      const cc = String(c).toLowerCase();
      if(h.includes(cc)) return i;
    }
  }
  return -1;
}

function normalizeCell(c){ return c && c.v != null ? String(c.v).trim() : ""; }

function buildGroups(table, mode){
  // mode: "out" = Andata (stopOut) • "back" = Ritorno (stopBack)
  const headers = (table.cols||[]).map(c => (c && c.label) ? c.label : "");
  const iTime   = pickColIndex(headers, H.time);
  const iPeople = pickColIndex(headers, H.people);
  const iStop   = pickColIndex(headers, mode==="out" ? H.stopOut : H.stopBack);

  if(iTime<0 || iStop<0 || iPeople<0){
    throw new Error(`Intestazioni non trovate (${mode}). Trovati: ${JSON.stringify(headers)}`);
  }
  const map = new Map(); // key: time|stop => count
  for(const r of table.rows){
    const cells = r.c || [];
    const time = normalizeCell(cells[iTime]);
    const stop = normalizeCell(cells[iStop]);
    const peopleRaw = normalizeCell(cells[iPeople]);
    const people = Number(peopleRaw.replace(",", ".")) || 0;
    if(!time || !stop || !people) continue;
    const key = `${time}|${stop}`;
    map.set(key, (map.get(key)||0) + people);
  }
  // convert to object grouped by time -> [{stop, people}]
  const byTime = {};
  for(const [key, val] of map){
    const [t, s] = key.split("|");
    if(!byTime[t]) byTime[t] = [];
    byTime[t].push({stop:s, people:val});
  }
  // sort times numericamente (hh:mm)
  const times = Object.keys(byTime).sort((a,b)=>{
    const [ah,am]=a.split(":").map(Number);
    const [bh,bm]=b.split(":").map(Number);
    return (ah*60+am)-(bh*60+bm);
  });
  return { times, byTime };
}

function renderSection(container, groups){
  container.innerHTML = "";
  if(groups.times.length===0){
    container.innerHTML = `<div class="empty">Nessun dato disponibile / Keine Daten verfügbar.</div>`;
    return;
  }
  for(const t of groups.times){
    const rows = groups.byTime[t].sort((a,b)=> a.stop.localeCompare(b.stop, undefined, {sensitivity:"base"}));
    const total = rows.reduce((s,x)=>s+x.people,0);
    const wrap = document.createElement("div");
    wrap.className = "slot";
    wrap.innerHTML = `
      <h3>${t} <span class="badge">${total} Personen / Persone</span></h3>
      <table class="table">
        <thead>
          <tr class="th">
            <th class="cell" style="text-align:left">Haltestelle / Fermata</th>
            <th class="cell">Personen / Persone</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    `;
    const tbody = wrap.querySelector("tbody");
    for(const r of rows){
      const tr = document.createElement("tr");
      tr.className = "rowline";
      tr.innerHTML = `
        <td class="cell">${r.stop}</td>
        <td class="cell">${r.people}</td>
      `;
      tbody.appendChild(tr);
    }
    container.appendChild(wrap);
  }
}

async function loadAll(){
  footerEl.textContent = "Aggiornamento in corso… / Wird aktualisiert…";
  let table = null, usedSheet = null;
  for(const name of CANDIDATE_SHEETS){
    try{
      table = await tryFetch(name);
      usedSheet = name;
      break;
    }catch(e){
      // prova prossimo
    }
  }
  if(!table){
    footerEl.textContent = "Impossibile leggere il Google Sheet. Verifica la pubblicazione o i permessi.";
    return;
  }
  try{
    const gOut  = buildGroups(table, "out");
    const gBack = buildGroups(table, "b
